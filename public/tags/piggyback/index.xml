<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
  <title>piggyback on %&gt;% dreams</title>
  <link>/tags/piggyback/</link>
  <description>Recent content in piggyback on %&gt;% dreams</description>
  <generator>Hugo -- gohugo.io</generator>
<language>en-us</language>
<lastBuildDate>Sun, 03 May 2020 00:00:00 +0000</lastBuildDate><atom:link href="/tags/piggyback/index.xml" rel="self" type="application/rss+xml" />
<item>
  <title>Creating an R Package for School District Shapefiles</title>
  <link>/blog/leaid-shapefiles/</link>
  <pubDate>Sun, 03 May 2020 00:00:00 +0000</pubDate>
  
<guid>/blog/leaid-shapefiles/</guid>
  <description>


&lt;p&gt;I would like to introduce &lt;a href=&#34;https://github.com/ivelasq/leaidr&#34;&gt;{leaidr}&lt;/a&gt;, a package for mapping U.S. School District shapefiles!&lt;/p&gt;
&lt;p&gt;Inspired by my coauthor &lt;a href=&#34;https://joshuamrosenberg.com/&#34;&gt;Joshua Rosenberg&lt;/a&gt;, the goal of {leaidr} is to facilitate the download and use of school district shapefiles.&lt;/p&gt;
&lt;p&gt;School districts in the U.S. have associated local education agency identification numbers (LEAID) used in the &lt;a href=&#34;https://nces.ed.gov/pubs2010/100largest0809/tables/table_d05.asp&#34;&gt;National Center for Education Statistics (NCES) Common Core of Data&lt;/a&gt;. These are very useful because if you have other datasets with NCES ID’s, then you can (sometimes easily) join them.&lt;/p&gt;
&lt;p&gt;It can be very useful to visualize districts and associated data. District shapefiles are available in different places, such as through the &lt;a href=&#34;https://nces.ed.gov/programs/edge/Geographic/DistrictBoundaries&#34;&gt;NCES&lt;/a&gt; and &lt;a href=&#34;https://exhibits.stanford.edu/data/catalog/db586ns4974&#34;&gt;Stanford Education Data Archive&lt;/a&gt;. The package {tigris} also has a school district option, but unfortunately it is missing a few district polygons.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(tigris)

ca &amp;lt;- tigris::school_districts(state = &amp;quot;06&amp;quot;,
                               type = &amp;quot;unified&amp;quot;)

plot(ca[&amp;quot;GEOID&amp;quot;])&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;/blog/leaid-shapefiles_files/figure-html/unnamed-chunk-1-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;{leaidr} downloads NCES’ U.S. district shapefile from Github using ROpenSci’s &lt;a href=&#34;https://github.com/ropensci/piggyback&#34;&gt;{piggyback}&lt;/a&gt; package. This is a super helpful package, as Github caps file uploads at 100 MB (and the shapefile is ~170 MB). I originally tried Github Large File Storage (LFS), but it stores files as a hash, not as an actual file. Therefore, I couldn’t figure out how to use it for a package that others can use.&lt;/p&gt;
&lt;p&gt;The function &lt;code&gt;lea_get()&lt;/code&gt; downloads an R Data file from the Github repo to your designated path and then writes the necessary shapefiles. Then, create an object with &lt;code&gt;lea_prep()&lt;/code&gt; by designating where the shapefiles exist and which state(s) you would like. &lt;strong&gt;Note:&lt;/strong&gt; For now, you must use the state’s FIPS code. FIPS state codes are numeric and two-letter alphabetic codes to identify U.S. states and certain other associated areas. A reference table is found &lt;a href=&#34;https://www.mcc.co.mercer.pa.us/dps/state_fips_code_listing.htm&#34;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Once you have the shapefile, then you can merge with other datasets and plot using packages like {leaflet} and {ggplot2}.&lt;/p&gt;
&lt;div id=&#34;example&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Example&lt;/h2&gt;
&lt;p&gt;Let’s walk through an example where we will merge external data to the shapefile and then map all the districts in California. The external data is from Josh’s &lt;a href=&#34;https://github.com/making-data-science-count/covidedu&#34;&gt;&lt;code&gt;covidedu&lt;/code&gt; project&lt;/a&gt;, which scrapes district websites for specific words. In this case, the search terms were “covid*”, “coron*”, and “closure”. I highly recommend using &lt;code&gt;covidedu&lt;/code&gt; for easy scraping from a &lt;strong&gt;lot&lt;/strong&gt; of district websites!&lt;/p&gt;
&lt;p&gt;First, let’s call our libraries.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(tidyverse)
# if you haven&amp;#39;t installed the package yet
# devtools::install_github(&amp;quot;ivelasq/leaidr&amp;quot;)
library(leaidr)
library(maptools)
library(viridis)
# if you don&amp;#39;t have this downloaded
# install.packages(&amp;quot;mapproj&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Time to get your data! Use {leaidr} to download and prep your shapefiles for California (FIPS == 06). Read in the external data (in this case, &lt;code&gt;summary-of-table-of-links.csv&lt;/code&gt;).&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Note:&lt;/strong&gt; You must have a GitHub PAT set to run &lt;code&gt;lea_get()&lt;/code&gt;. &lt;a href=&#34;https://happygitwithr.com/github-pat.html&#34;&gt;Happy git with R&lt;/a&gt; has a great walkthrough on how to do that.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# download the shapefile into a designated folder
leaidr::lea_get(path = &amp;quot;./test&amp;quot;)

# prep the shapefile for the state(s) you&amp;#39;d like
ca_shapefile &amp;lt;-
  leaidr::lea_prep(path = &amp;quot;./test&amp;quot;, fips = &amp;quot;06&amp;quot;)

# read in the external data that also has NCES ID&amp;#39;s
# this is from the covidedu project
ca_data &amp;lt;-
  read_csv(&amp;quot;https://raw.githubusercontent.com/making-data-science-count/covidedu/master/output/2020-04-29/summary-of-table-of-links.csv&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Join the CSV to the shapefile.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;ca_merge &amp;lt;-
  sp::merge(ca_shapefile, ca_data, by.x = &amp;quot;GEOID&amp;quot;, by.y = &amp;quot;nces_id&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now ‘fortify’ the data - this converts the polygons into points. This is so ggplot can create the plot.&lt;/p&gt;
&lt;p&gt;If you get the error &lt;code&gt;isTRUE(gpclibPermitStatus()) is not TRUE&lt;/code&gt;, then you need to enable &lt;code&gt;gpclib&lt;/code&gt; by running &lt;code&gt;gpclibPermit()&lt;/code&gt; (this is part of the {maptools} package, which should have been loaded above). Note that support for &lt;code&gt;gpclib&lt;/code&gt; will be withdrawn from maptools at the next major release, so you might have to try something else if the package has been upgraded.&lt;/p&gt;
&lt;p&gt;If you run &lt;code&gt;gpclibPermit()&lt;/code&gt; and you keep getting &lt;code&gt;FALSE&lt;/code&gt;, then you are missing the package {gpclib}. Install the package, then run &lt;code&gt;gpclibPermit()&lt;/code&gt; to set it to &lt;code&gt;TRUE&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;(I don’t know if this is the best/only way to do this - if anybody has suggestions, please let me know!)&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# install.package(&amp;quot;gpclib&amp;quot;)
gpclibPermit()
ca_points &amp;lt;- fortify(ca_merge, region = &amp;quot;GEOID&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now, join the points and the shapefile data.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;ca_df &amp;lt;- left_join(ca_merge@data, ca_points, by = c(&amp;quot;GEOID&amp;quot; = &amp;quot;id&amp;quot;))&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We can finally plot the shapefile and its data!&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;ca_map &amp;lt;-
  ca_df %&amp;gt;% 
  ggplot() +
  geom_polygon(aes(x = long, 
                   y = lat, 
                   group = group,
                   fill = any_link_found),
               color = &amp;quot;gray&amp;quot;, 
               size = .2) +
  theme_void() +
  scale_fill_viridis(option = &amp;quot;cividis&amp;quot;, discrete = TRUE) +
  ggtitle(&amp;quot;COVID-Related Links Found on CA School District Sites&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;To make a nicer looking map, then you can use &lt;code&gt;coord_map()&lt;/code&gt;.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;map_projected &amp;lt;- ca_map +
  coord_map()

print(map_projected)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;https://ivelasq.rbind.io/img/leaid-shapefiles/test_map.png&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Tada! A full school district map for California.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;call-for-collaboration&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Call for Collaboration&lt;/h2&gt;
&lt;p&gt;Please try out {leaidr}! I hope that it is useful to you in your work. I’d love any collaborators to join me in making it easier/better!&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Other functionalities&lt;/strong&gt;: Thinking of: being able to filter shapefiles by NCES IDs as well as states; adding commonly used data (like district demographics).&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Issues&lt;/strong&gt;: If you run into any issues, please post on the &lt;a href=&#34;https://github.com/ivelasq/leaidr/issues&#34;&gt;GitHub page!&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div id=&#34;resources&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Resources&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;#%20joining%20spatial%20data:%20http://www.nickeubank.com/wp-content/uploads/2015/10/RGIS2_MergingSpatialData_part1_Joins.html&#34;&gt;&lt;strong&gt;Joining Spatial Data&lt;/strong&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://rpubs.com/DanielSLee/censusMap&#34;&gt;&lt;strong&gt;Analyzing U.S. Census Data Using R&lt;/strong&gt;&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
</description>
  </item>
  
</channel>
  </rss>